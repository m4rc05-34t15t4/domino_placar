--30/06/2025

--qery paa add com verificação
$sql = "INSERT INTO partida (data_hora, jogador1_id, jogador2_id, jogador3_id, jogador4_id, placar1, placar2, jogadorbct, jogadas )
                SELECT :dataHora, :j1, :j2, :j3, :j4, :placar1, :placar2, :bct, :jogadas
                WHERE NOT EXISTS (
                    SELECT 1 FROM partida
                    WHERE 
                        ABS(EXTRACT(EPOCH FROM (data_hora - TIMESTAMP :dataHora))) <= 300
                        AND jogadorbct = :bct
                        AND (
                        -- Combinação normal
                        (jogador1_id = :j1 AND jogador2_id = :j2)
                        OR (jogador1_id = :j2 AND jogador2_id = :j1)
                        )
                        AND (
                        (jogador3_id = :j3 AND jogador4_id = :j4)
                        OR (jogador3_id = :j4 AND jogador4_id = :j3)
                        )
                    )
                RETURNING id;
                ";

CREATE OR REPLACE VIEW public.vw_jogador_estatistica_sinuca_ultimos_jogos AS
WITH partidas_expandidas AS (
    SELECT id AS partida_id, data_hora, jogador1_id AS jogador_id
    FROM vw_partida_sinuca_com_vencedor
    UNION ALL
    SELECT id, data_hora, jogador2_id
    FROM vw_partida_sinuca_com_vencedor
),
ranked_participacoes AS (
    SELECT 
        jogador_id,
        partida_id,
        data_hora,
        ROW_NUMBER() OVER (PARTITION BY jogador_id ORDER BY data_hora DESC) AS rn
    FROM partidas_expandidas
),
partidas_filtradas AS (
    SELECT jogador_id, partida_id
    FROM ranked_participacoes
    WHERE rn <= 15
),
partidas_jogador_filtradas AS (
    SELECT p.*
    FROM vw_partida_sinuca_com_vencedor p
    JOIN partidas_filtradas f 
      ON p.id = f.partida_id
    WHERE f.jogador_id IN (p.jogador1_id, p.jogador2_id)
)
SELECT 
    j.id,
    j.nome,
    COUNT(p.id) AS qtd_partidas_utilizadas,
    SUM(CASE
        WHEN j.id = p.jogador1_id AND p.vencedor = 'A' THEN 1
        WHEN j.id = p.jogador2_id AND p.vencedor = 'B' THEN 1
        ELSE 0
    END) AS vitorias,
    SUM(CASE
        WHEN j.id = p.jogador1_id AND p.vencedor = 'B' THEN 1
        WHEN j.id = p.jogador2_id AND p.vencedor = 'A' THEN 1
        ELSE 0
    END) AS derrotas,
    SUM(CASE
        WHEN (j.id = p.jogador1_id OR j.id = p.jogador2_id) AND p.vencedor = 'AB' THEN 1
        ELSE 0
    END) AS empates,
    SUM(CASE
        WHEN p.jogadorbct IS NOT NULL AND (
            (p.jogadorbct = 1 AND j.id = p.jogador1_id) OR 
            (p.jogadorbct = 2 AND j.id = p.jogador2_id)
        ) THEN 1
        ELSE 0
    END) AS merda,
    SUM(CASE
        WHEN (p.vencedor = 'A' AND p.placar2 = 0 AND p.jogador1_id = j.id) OR
             (p.vencedor = 'B' AND p.placar1 = 0 AND p.jogador2_id = j.id) THEN 1
        ELSE 0
    END) AS merito,
    SUM(CASE
        WHEN j.id = p.jogador1_id AND p.vencedor = 'A' THEN p.placar1
        WHEN j.id = p.jogador2_id AND p.vencedor = 'B' THEN p.placar2
        ELSE 0
    END) AS placar_vitoria,
    SUM(CASE
        WHEN j.id = p.jogador1_id AND p.vencedor = 'B' THEN p.placar1
        WHEN j.id = p.jogador2_id AND p.vencedor = 'A' THEN p.placar2
        ELSE 0
    END) AS placar_derrota
FROM jogador j
LEFT JOIN partidas_jogador_filtradas p 
       ON j.id = p.jogador1_id OR j.id = p.jogador2_id
GROUP BY j.id, j.nome
ORDER BY qtd_partidas_utilizadas DESC;



CREATE OR REPLACE VIEW public.vw_jogador_estatistica_sinuca_expediente_ultimos_jogos AS
WITH partidas_expandidas AS (
    SELECT id AS partida_id, data_hora, jogador1_id AS jogador_id
    FROM vw_partida_sinuca_com_vencedor 
	WHERE vw_partida_sinuca_com_vencedor.data_hora::time without time zone >= '12:00:00'::time without time zone AND vw_partida_sinuca_com_vencedor.data_hora::time without time zone <= '13:10:00'::time without time zone
    UNION ALL
    SELECT id, data_hora, jogador2_id
    FROM vw_partida_sinuca_com_vencedor
	WHERE vw_partida_sinuca_com_vencedor.data_hora::time without time zone >= '12:00:00'::time without time zone AND vw_partida_sinuca_com_vencedor.data_hora::time without time zone <= '13:10:00'::time without time zone
),
ranked_participacoes AS (
    SELECT 
        jogador_id,
        partida_id,
        data_hora,
        ROW_NUMBER() OVER (PARTITION BY jogador_id ORDER BY data_hora DESC) AS rn
    FROM partidas_expandidas
),
partidas_filtradas AS (
    SELECT jogador_id, partida_id
    FROM ranked_participacoes
    WHERE rn <= 15
),
partidas_jogador_filtradas AS (
    SELECT p.*
    FROM vw_partida_sinuca_com_vencedor p
    JOIN partidas_filtradas f 
      ON p.id = f.partida_id
    WHERE f.jogador_id IN (p.jogador1_id, p.jogador2_id)
)
SELECT 
    j.id,
    j.nome,
    COUNT(p.id) AS qtd_partidas_utilizadas,
    SUM(CASE
        WHEN j.id = p.jogador1_id AND p.vencedor = 'A' THEN 1
        WHEN j.id = p.jogador2_id AND p.vencedor = 'B' THEN 1
        ELSE 0
    END) AS vitorias,
    SUM(CASE
        WHEN j.id = p.jogador1_id AND p.vencedor = 'B' THEN 1
        WHEN j.id = p.jogador2_id AND p.vencedor = 'A' THEN 1
        ELSE 0
    END) AS derrotas,
    SUM(CASE
        WHEN (j.id = p.jogador1_id OR j.id = p.jogador2_id) AND p.vencedor = 'AB' THEN 1
        ELSE 0
    END) AS empates,
    SUM(CASE
        WHEN p.jogadorbct IS NOT NULL AND (
            (p.jogadorbct = 1 AND j.id = p.jogador1_id) OR 
            (p.jogadorbct = 2 AND j.id = p.jogador2_id)
        ) THEN 1
        ELSE 0
    END) AS merda,
    SUM(CASE
        WHEN (p.vencedor = 'A' AND p.placar2 = 0 AND p.jogador1_id = j.id) OR
             (p.vencedor = 'B' AND p.placar1 = 0 AND p.jogador2_id = j.id) THEN 1
        ELSE 0
    END) AS merito,
    SUM(CASE
        WHEN j.id = p.jogador1_id AND p.vencedor = 'A' THEN p.placar1
        WHEN j.id = p.jogador2_id AND p.vencedor = 'B' THEN p.placar2
        ELSE 0
    END) AS placar_vitoria,
    SUM(CASE
        WHEN j.id = p.jogador1_id AND p.vencedor = 'B' THEN p.placar1
        WHEN j.id = p.jogador2_id AND p.vencedor = 'A' THEN p.placar2
        ELSE 0
    END) AS placar_derrota
FROM jogador j
LEFT JOIN partidas_jogador_filtradas p 
       ON j.id = p.jogador1_id OR j.id = p.jogador2_id
GROUP BY j.id, j.nome
ORDER BY qtd_partidas_utilizadas DESC;



CREATE OR REPLACE VIEW public.vw_jogador_estatistica_sinuca_fora_expediente_ultimos_jogos AS
WITH partidas_expandidas AS (
    SELECT id AS partida_id, data_hora, jogador1_id AS jogador_id
    FROM vw_partida_sinuca_com_vencedor 
	WHERE vw_partida_sinuca_com_vencedor.data_hora::time without time zone < '12:00:00'::time without time zone OR vw_partida_sinuca_com_vencedor.data_hora::time without time zone > '13:10:00'::time without time zone
    UNION ALL
    SELECT id, data_hora, jogador2_id
    FROM vw_partida_sinuca_com_vencedor
	WHERE vw_partida_sinuca_com_vencedor.data_hora::time without time zone < '12:00:00'::time without time zone OR vw_partida_sinuca_com_vencedor.data_hora::time without time zone > '13:10:00'::time without time zone
),
ranked_participacoes AS (
    SELECT 
        jogador_id,
        partida_id,
        data_hora,
        ROW_NUMBER() OVER (PARTITION BY jogador_id ORDER BY data_hora DESC) AS rn
    FROM partidas_expandidas
),
partidas_filtradas AS (
    SELECT jogador_id, partida_id
    FROM ranked_participacoes
    WHERE rn <= 15
),
partidas_jogador_filtradas AS (
    SELECT p.*
    FROM vw_partida_sinuca_com_vencedor p
    JOIN partidas_filtradas f 
      ON p.id = f.partida_id
    WHERE f.jogador_id IN (p.jogador1_id, p.jogador2_id)
)
SELECT 
    j.id,
    j.nome,
    COUNT(p.id) AS qtd_partidas_utilizadas,
    SUM(CASE
        WHEN j.id = p.jogador1_id AND p.vencedor = 'A' THEN 1
        WHEN j.id = p.jogador2_id AND p.vencedor = 'B' THEN 1
        ELSE 0
    END) AS vitorias,
    SUM(CASE
        WHEN j.id = p.jogador1_id AND p.vencedor = 'B' THEN 1
        WHEN j.id = p.jogador2_id AND p.vencedor = 'A' THEN 1
        ELSE 0
    END) AS derrotas,
    SUM(CASE
        WHEN (j.id = p.jogador1_id OR j.id = p.jogador2_id) AND p.vencedor = 'AB' THEN 1
        ELSE 0
    END) AS empates,
    SUM(CASE
        WHEN p.jogadorbct IS NOT NULL AND (
            (p.jogadorbct = 1 AND j.id = p.jogador1_id) OR 
            (p.jogadorbct = 2 AND j.id = p.jogador2_id)
        ) THEN 1
        ELSE 0
    END) AS merda,
    SUM(CASE
        WHEN (p.vencedor = 'A' AND p.placar2 = 0 AND p.jogador1_id = j.id) OR
             (p.vencedor = 'B' AND p.placar1 = 0 AND p.jogador2_id = j.id) THEN 1
        ELSE 0
    END) AS merito,
    SUM(CASE
        WHEN j.id = p.jogador1_id AND p.vencedor = 'A' THEN p.placar1
        WHEN j.id = p.jogador2_id AND p.vencedor = 'B' THEN p.placar2
        ELSE 0
    END) AS placar_vitoria,
    SUM(CASE
        WHEN j.id = p.jogador1_id AND p.vencedor = 'B' THEN p.placar1
        WHEN j.id = p.jogador2_id AND p.vencedor = 'A' THEN p.placar2
        ELSE 0
    END) AS placar_derrota
FROM jogador j
LEFT JOIN partidas_jogador_filtradas p 
       ON j.id = p.jogador1_id OR j.id = p.jogador2_id
GROUP BY j.id, j.nome
ORDER BY qtd_partidas_utilizadas DESC;



CREATE OR REPLACE VIEW public.vw_jogador_estatistica_expediente_ultimos_jogos AS
WITH partidas_expandidas AS (
    SELECT id AS partida_id, data_hora, jogador1_id AS jogador_id
    FROM vw_partida_com_vencedor
    WHERE data_hora::time >= '12:00:00'::time AND data_hora::time <= '13:10:00'::time
    UNION ALL
    SELECT id, data_hora, jogador2_id FROM vw_partida_com_vencedor
    WHERE data_hora::time >= '12:00:00'::time AND data_hora::time <= '13:10:00'::time
    UNION ALL
    SELECT id, data_hora, jogador3_id FROM vw_partida_com_vencedor
    WHERE data_hora::time >= '12:00:00'::time AND data_hora::time <= '13:10:00'::time
    UNION ALL
    SELECT id, data_hora, jogador4_id FROM vw_partida_com_vencedor
    WHERE data_hora::time >= '12:00:00'::time AND data_hora::time <= '13:10:00'::time
),
ranked_participacoes AS (
    SELECT 
        jogador_id,
        partida_id,
        data_hora,
        ROW_NUMBER() OVER (PARTITION BY jogador_id ORDER BY data_hora DESC) AS rn
    FROM partidas_expandidas
),
partidas_filtradas AS (
    SELECT DISTINCT partida_id, jogador_id
    FROM ranked_participacoes
    WHERE rn <= 15
),
qtd_partidas_utilizadas AS (
    SELECT jogador_id, COUNT(*) AS qtd_partidas_utilizadas
    FROM partidas_filtradas
    GROUP BY jogador_id
),
partidas_jogador_filtradas AS (
    SELECT p.*
    FROM vw_partida_com_vencedor p
    JOIN partidas_filtradas f ON p.id = f.partida_id
    WHERE f.jogador_id IN (p.jogador1_id, p.jogador2_id, p.jogador3_id, p.jogador4_id)
)
SELECT j.id,
       j.nome,
       COUNT(*) AS partidas,
       q.qtd_partidas_utilizadas,
       SUM(CASE
           WHEN (j.id = p.jogador1_id OR j.id = p.jogador2_id) AND p.dupla_vencedora = 'A' THEN 1
           WHEN (j.id = p.jogador3_id OR j.id = p.jogador4_id) AND p.dupla_vencedora = 'B' THEN 1
           ELSE 0
       END) AS vitorias,
       SUM(CASE
           WHEN (j.id = p.jogador1_id OR j.id = p.jogador2_id) AND p.dupla_vencedora = 'B' THEN 1
           WHEN (j.id = p.jogador3_id OR j.id = p.jogador4_id) AND p.dupla_vencedora = 'A' THEN 1
           ELSE 0
       END) AS derrotas,
       SUM(CASE
           WHEN j.id IN (p.jogador1_id, p.jogador2_id, p.jogador3_id, p.jogador4_id)
                AND p.dupla_vencedora = 'AB' THEN 1
           ELSE 0
       END) AS empates,
       SUM(CASE
           WHEN p.jogadorbct IS NOT NULL AND (
               (p.jogadorbct = 1 AND j.id = p.jogador1_id) OR
               (p.jogadorbct = 2 AND j.id = p.jogador2_id) OR
               (p.jogadorbct = 3 AND j.id = p.jogador3_id) OR
               (p.jogadorbct = 4 AND j.id = p.jogador4_id)
           ) THEN 1
           ELSE 0
       END) AS merda,
       SUM(CASE
           WHEN (
               ((j.id = p.jogador1_id OR j.id = p.jogador2_id) AND p.dupla_vencedora = 'A') OR
               ((j.id = p.jogador3_id OR j.id = p.jogador4_id) AND p.dupla_vencedora = 'B')
           ) AND (p.jogadas ILIKE '%C%' OR p.jogadas ILIKE '%L%') THEN 1
           ELSE 0
       END) AS merito,
       SUM(CASE
           WHEN (
               ((j.id = p.jogador1_id OR j.id = p.jogador2_id) AND p.dupla_vencedora = 'A') OR
               ((j.id = p.jogador3_id OR j.id = p.jogador4_id) AND p.dupla_vencedora = 'B')
           ) AND p.jogadas ILIKE '%L%' THEN 1
           ELSE 0
       END) AS laelo,
       SUM(CASE
           WHEN (
               ((j.id = p.jogador1_id OR j.id = p.jogador2_id) AND p.dupla_vencedora = 'A') OR
               ((j.id = p.jogador3_id OR j.id = p.jogador4_id) AND p.dupla_vencedora = 'B')
           ) AND p.jogadas ILIKE '%C%' THEN 1
           ELSE 0
       END) AS cruzada,
       SUM(CASE
           WHEN (j.id = p.jogador1_id OR j.id = p.jogador2_id) AND p.dupla_vencedora = 'A' THEN p.placar1
           WHEN (j.id = p.jogador3_id OR j.id = p.jogador4_id) AND p.dupla_vencedora = 'B' THEN p.placar2
           ELSE 0
       END) AS placar_vitoria,
       SUM(CASE
           WHEN (j.id = p.jogador1_id OR j.id = p.jogador2_id) AND p.dupla_vencedora = 'B' THEN p.placar1
           WHEN (j.id = p.jogador3_id OR j.id = p.jogador4_id) AND p.dupla_vencedora = 'A' THEN p.placar2
           ELSE 0
       END) AS placar_derrota
FROM jogador j
LEFT JOIN partidas_jogador_filtradas p 
       ON j.id IN (p.jogador1_id, p.jogador2_id, p.jogador3_id, p.jogador4_id)
LEFT JOIN qtd_partidas_utilizadas q ON j.id = q.jogador_id
GROUP BY j.id, j.nome, q.qtd_partidas_utilizadas
ORDER BY COUNT(*) DESC;


CREATE OR REPLACE VIEW public.vw_jogador_estatistica_fora_expediente_ultimos_jogos AS
WITH partidas_expandidas AS (
    SELECT id AS partida_id, data_hora, jogador1_id AS jogador_id
    FROM vw_partida_com_vencedor
    WHERE data_hora::time < '12:00:00'::time OR data_hora::time > '13:10:00'::time
    UNION ALL
    SELECT id, data_hora, jogador2_id FROM vw_partida_com_vencedor
    WHERE data_hora::time < '12:00:00'::time OR data_hora::time > '13:10:00'::time
    UNION ALL
    SELECT id, data_hora, jogador3_id FROM vw_partida_com_vencedor
    WHERE data_hora::time < '12:00:00'::time OR data_hora::time > '13:10:00'::time
    UNION ALL
    SELECT id, data_hora, jogador4_id FROM vw_partida_com_vencedor
    WHERE data_hora::time < '12:00:00'::time OR data_hora::time > '13:10:00'::time
),
ranked_participacoes AS (
    SELECT 
        jogador_id,
        partida_id,
        data_hora,
        ROW_NUMBER() OVER (PARTITION BY jogador_id ORDER BY data_hora DESC) AS rn
    FROM partidas_expandidas
),
partidas_filtradas AS (
    SELECT DISTINCT partida_id, jogador_id
    FROM ranked_participacoes
    WHERE rn <= 15
),
qtd_partidas_utilizadas AS (
    SELECT jogador_id, COUNT(*) AS qtd_partidas_utilizadas
    FROM partidas_filtradas
    GROUP BY jogador_id
),
partidas_jogador_filtradas AS (
    SELECT p.*
    FROM vw_partida_com_vencedor p
    JOIN partidas_filtradas f ON p.id = f.partida_id
    WHERE f.jogador_id IN (p.jogador1_id, p.jogador2_id, p.jogador3_id, p.jogador4_id)
)
SELECT j.id,
       j.nome,
       COUNT(*) AS partidas,
       q.qtd_partidas_utilizadas,
       SUM(CASE
           WHEN (j.id = p.jogador1_id OR j.id = p.jogador2_id) AND p.dupla_vencedora = 'A' THEN 1
           WHEN (j.id = p.jogador3_id OR j.id = p.jogador4_id) AND p.dupla_vencedora = 'B' THEN 1
           ELSE 0
       END) AS vitorias,
       SUM(CASE
           WHEN (j.id = p.jogador1_id OR j.id = p.jogador2_id) AND p.dupla_vencedora = 'B' THEN 1
           WHEN (j.id = p.jogador3_id OR j.id = p.jogador4_id) AND p.dupla_vencedora = 'A' THEN 1
           ELSE 0
       END) AS derrotas,
       SUM(CASE
           WHEN j.id IN (p.jogador1_id, p.jogador2_id, p.jogador3_id, p.jogador4_id)
                AND p.dupla_vencedora = 'AB' THEN 1
           ELSE 0
       END) AS empates,
       SUM(CASE
           WHEN p.jogadorbct IS NOT NULL AND (
               (p.jogadorbct = 1 AND j.id = p.jogador1_id) OR
               (p.jogadorbct = 2 AND j.id = p.jogador2_id) OR
               (p.jogadorbct = 3 AND j.id = p.jogador3_id) OR
               (p.jogadorbct = 4 AND j.id = p.jogador4_id)
           ) THEN 1
           ELSE 0
       END) AS merda,
       SUM(CASE
           WHEN (
               ((j.id = p.jogador1_id OR j.id = p.jogador2_id) AND p.dupla_vencedora = 'A') OR
               ((j.id = p.jogador3_id OR j.id = p.jogador4_id) AND p.dupla_vencedora = 'B')
           ) AND (p.jogadas ILIKE '%C%' OR p.jogadas ILIKE '%L%') THEN 1
           ELSE 0
       END) AS merito,
       SUM(CASE
           WHEN (
               ((j.id = p.jogador1_id OR j.id = p.jogador2_id) AND p.dupla_vencedora = 'A') OR
               ((j.id = p.jogador3_id OR j.id = p.jogador4_id) AND p.dupla_vencedora = 'B')
           ) AND p.jogadas ILIKE '%L%' THEN 1
           ELSE 0
       END) AS laelo,
       SUM(CASE
           WHEN (
               ((j.id = p.jogador1_id OR j.id = p.jogador2_id) AND p.dupla_vencedora = 'A') OR
               ((j.id = p.jogador3_id OR j.id = p.jogador4_id) AND p.dupla_vencedora = 'B')
           ) AND p.jogadas ILIKE '%C%' THEN 1
           ELSE 0
       END) AS cruzada,
       SUM(CASE
           WHEN (j.id = p.jogador1_id OR j.id = p.jogador2_id) AND p.dupla_vencedora = 'A' THEN p.placar1
           WHEN (j.id = p.jogador3_id OR j.id = p.jogador4_id) AND p.dupla_vencedora = 'B' THEN p.placar2
           ELSE 0
       END) AS placar_vitoria,
       SUM(CASE
           WHEN (j.id = p.jogador1_id OR j.id = p.jogador2_id) AND p.dupla_vencedora = 'B' THEN p.placar1
           WHEN (j.id = p.jogador3_id OR j.id = p.jogador4_id) AND p.dupla_vencedora = 'A' THEN p.placar2
           ELSE 0
       END) AS placar_derrota
FROM jogador j
LEFT JOIN partidas_jogador_filtradas p 
       ON j.id IN (p.jogador1_id, p.jogador2_id, p.jogador3_id, p.jogador4_id)
LEFT JOIN qtd_partidas_utilizadas q ON j.id = q.jogador_id
GROUP BY j.id, j.nome, q.qtd_partidas_utilizadas
ORDER BY COUNT(*) DESC;



CREATE OR REPLACE VIEW public.vw_jogador_estatistica_ultimos_jogos AS
WITH partidas_expandidas AS (
    SELECT id AS partida_id, data_hora, jogador1_id AS jogador_id
    FROM vw_partida_com_vencedor
    UNION ALL
    SELECT id, data_hora, jogador2_id FROM vw_partida_com_vencedor
    UNION ALL
    SELECT id, data_hora, jogador3_id FROM vw_partida_com_vencedor
    UNION ALL
    SELECT id, data_hora, jogador4_id FROM vw_partida_com_vencedor
),
ranked_participacoes AS (
    SELECT 
        jogador_id,
        partida_id,
        data_hora,
        ROW_NUMBER() OVER (PARTITION BY jogador_id ORDER BY data_hora DESC) AS rn
    FROM partidas_expandidas
),
partidas_filtradas AS (
    SELECT DISTINCT partida_id, jogador_id
    FROM ranked_participacoes
    WHERE rn <= 15
),
qtd_partidas_utilizadas AS (
    SELECT jogador_id, COUNT(*) AS qtd_partidas_utilizadas
    FROM partidas_filtradas
    GROUP BY jogador_id
),
partidas_jogador_filtradas AS (
    SELECT p.*
    FROM vw_partida_com_vencedor p
    JOIN partidas_filtradas f ON p.id = f.partida_id
    WHERE f.jogador_id IN (p.jogador1_id, p.jogador2_id, p.jogador3_id, p.jogador4_id)
)
SELECT j.id,
       j.nome,
       COUNT(*) AS partidas,
       q.qtd_partidas_utilizadas,
       SUM(CASE
           WHEN (j.id = p.jogador1_id OR j.id = p.jogador2_id) AND p.dupla_vencedora = 'A' THEN 1
           WHEN (j.id = p.jogador3_id OR j.id = p.jogador4_id) AND p.dupla_vencedora = 'B' THEN 1
           ELSE 0
       END) AS vitorias,
       SUM(CASE
           WHEN (j.id = p.jogador1_id OR j.id = p.jogador2_id) AND p.dupla_vencedora = 'B' THEN 1
           WHEN (j.id = p.jogador3_id OR j.id = p.jogador4_id) AND p.dupla_vencedora = 'A' THEN 1
           ELSE 0
       END) AS derrotas,
       SUM(CASE
           WHEN j.id IN (p.jogador1_id, p.jogador2_id, p.jogador3_id, p.jogador4_id)
                AND p.dupla_vencedora = 'AB' THEN 1
           ELSE 0
       END) AS empates,
       SUM(CASE
           WHEN p.jogadorbct IS NOT NULL AND (
               (p.jogadorbct = 1 AND j.id = p.jogador1_id) OR
               (p.jogadorbct = 2 AND j.id = p.jogador2_id) OR
               (p.jogadorbct = 3 AND j.id = p.jogador3_id) OR
               (p.jogadorbct = 4 AND j.id = p.jogador4_id)
           ) THEN 1
           ELSE 0
       END) AS merda,
       SUM(CASE
           WHEN (
               ((j.id = p.jogador1_id OR j.id = p.jogador2_id) AND p.dupla_vencedora = 'A') OR
               ((j.id = p.jogador3_id OR j.id = p.jogador4_id) AND p.dupla_vencedora = 'B')
           ) AND (p.jogadas ILIKE '%C%' OR p.jogadas ILIKE '%L%') THEN 1
           ELSE 0
       END) AS merito,
       SUM(CASE
           WHEN (
               ((j.id = p.jogador1_id OR j.id = p.jogador2_id) AND p.dupla_vencedora = 'A') OR
               ((j.id = p.jogador3_id OR j.id = p.jogador4_id) AND p.dupla_vencedora = 'B')
           ) AND p.jogadas ILIKE '%L%' THEN 1
           ELSE 0
       END) AS laelo,
       SUM(CASE
           WHEN (
               ((j.id = p.jogador1_id OR j.id = p.jogador2_id) AND p.dupla_vencedora = 'A') OR
               ((j.id = p.jogador3_id OR j.id = p.jogador4_id) AND p.dupla_vencedora = 'B')
           ) AND p.jogadas ILIKE '%C%' THEN 1
           ELSE 0
       END) AS cruzada,
       SUM(CASE
           WHEN (j.id = p.jogador1_id OR j.id = p.jogador2_id) AND p.dupla_vencedora = 'A' THEN p.placar1
           WHEN (j.id = p.jogador3_id OR j.id = p.jogador4_id) AND p.dupla_vencedora = 'B' THEN p.placar2
           ELSE 0
       END) AS placar_vitoria,
       SUM(CASE
           WHEN (j.id = p.jogador1_id OR j.id = p.jogador2_id) AND p.dupla_vencedora = 'B' THEN p.placar1
           WHEN (j.id = p.jogador3_id OR j.id = p.jogador4_id) AND p.dupla_vencedora = 'A' THEN p.placar2
           ELSE 0
       END) AS placar_derrota
FROM jogador j
LEFT JOIN partidas_jogador_filtradas p 
       ON j.id IN (p.jogador1_id, p.jogador2_id, p.jogador3_id, p.jogador4_id)
LEFT JOIN qtd_partidas_utilizadas q ON j.id = q.jogador_id
GROUP BY j.id, j.nome, q.qtd_partidas_utilizadas
ORDER BY COUNT(*) DESC;





--verificar qtd partidas utilizadas por jogador 
WITH partidas_expandidas AS (
    SELECT id AS partida_id, data_hora, jogador1_id AS jogador_id FROM partida
    UNION ALL
    SELECT id, data_hora, jogador2_id FROM partida
    UNION ALL
    SELECT id, data_hora, jogador3_id FROM partida
    UNION ALL
    SELECT id, data_hora, jogador4_id FROM partida
),
ranked_participacoes AS (
    SELECT 
        jogador_id,
        partida_id,
        data_hora,
        ROW_NUMBER() OVER (PARTITION BY jogador_id ORDER BY data_hora DESC) AS rn
    FROM partidas_expandidas
),
partidas_filtradas AS (
    SELECT DISTINCT partida_id
    FROM ranked_participacoes
    WHERE rn <= 2
),
participacoes_filtradas AS (
    SELECT 
        pe.jogador_id
    FROM partidas_expandidas pe
    JOIN partidas_filtradas pf ON pe.partida_id = pf.partida_id
)
SELECT 
    jogador_id,
    COUNT(*) AS qtd_partidas
FROM participacoes_filtradas
GROUP BY jogador_id
ORDER BY qtd_partidas DESC;



--27/06/2025

CREATE OR REPLACE VIEW public.vw_jogador_estatistica_sinuca_fora_expediente
 AS
 SELECT j.id,
    j.nome,
    count(p.id) AS partidas_sinuca,
    sum(
        CASE
            WHEN j.id = p.jogador1_id AND p.vencedor = 'A'::text THEN 1
            WHEN j.id = p.jogador2_id AND p.vencedor = 'B'::text THEN 1
            ELSE 0
        END) AS vitorias,
    sum(
        CASE
            WHEN j.id = p.jogador1_id AND p.vencedor = 'B'::text THEN 1
            WHEN j.id = p.jogador2_id AND p.vencedor = 'A'::text THEN 1
            ELSE 0
        END) AS derrotas,
    sum(
        CASE
            WHEN (j.id = p.jogador1_id OR j.id = p.jogador2_id) AND p.vencedor = 'AB'::text THEN 1
            ELSE 0
        END) AS empates,
    sum(
        CASE
            WHEN p.jogadorbct IS NOT NULL AND (p.jogadorbct = 1 AND j.id = p.jogador1_id OR p.jogadorbct = 2 AND j.id = p.jogador2_id) THEN 1
            ELSE 0
        END) AS merda,
    sum(
        CASE
            WHEN p.vencedor = 'A'::text AND p.placar2 = 0 AND p.jogador1_id = j.id OR p.vencedor = 'B'::text AND p.placar1 = 0 AND p.jogador2_id = j.id THEN 1
            ELSE 0
        END) AS merito,
    sum(
        CASE
            WHEN j.id = p.jogador1_id AND p.vencedor = 'A'::text THEN p.placar1
            WHEN j.id = p.jogador2_id AND p.vencedor = 'B'::text THEN p.placar2
            ELSE 0
        END) AS placar_vitoria,
    sum(
        CASE
            WHEN j.id = p.jogador1_id AND p.vencedor = 'B'::text THEN p.placar1
            WHEN j.id = p.jogador2_id AND p.vencedor = 'A'::text THEN p.placar2
            ELSE 0
        END) AS placar_derrota
   FROM jogador j
     LEFT JOIN (
    SELECT * 
    FROM public.vw_partida_sinuca_com_vencedor
    WHERE data_hora::time NOT BETWEEN TIME '12:00' AND TIME '13:10'
) p ON j.id = p.jogador1_id OR j.id = p.jogador2_id
  GROUP BY j.id, j.nome
  ORDER BY (count(p.id)) DESC;


CREATE OR REPLACE VIEW public.vw_jogador_estatistica_sinuca_expediente
 AS
 SELECT j.id,
    j.nome,
    count(p.id) AS partidas_sinuca,
    sum(
        CASE
            WHEN j.id = p.jogador1_id AND p.vencedor = 'A'::text THEN 1
            WHEN j.id = p.jogador2_id AND p.vencedor = 'B'::text THEN 1
            ELSE 0
        END) AS vitorias,
    sum(
        CASE
            WHEN j.id = p.jogador1_id AND p.vencedor = 'B'::text THEN 1
            WHEN j.id = p.jogador2_id AND p.vencedor = 'A'::text THEN 1
            ELSE 0
        END) AS derrotas,
    sum(
        CASE
            WHEN (j.id = p.jogador1_id OR j.id = p.jogador2_id) AND p.vencedor = 'AB'::text THEN 1
            ELSE 0
        END) AS empates,
    sum(
        CASE
            WHEN p.jogadorbct IS NOT NULL AND (p.jogadorbct = 1 AND j.id = p.jogador1_id OR p.jogadorbct = 2 AND j.id = p.jogador2_id) THEN 1
            ELSE 0
        END) AS merda,
    sum(
        CASE
            WHEN p.vencedor = 'A'::text AND p.placar2 = 0 AND p.jogador1_id = j.id OR p.vencedor = 'B'::text AND p.placar1 = 0 AND p.jogador2_id = j.id THEN 1
            ELSE 0
        END) AS merito,
    sum(
        CASE
            WHEN j.id = p.jogador1_id AND p.vencedor = 'A'::text THEN p.placar1
            WHEN j.id = p.jogador2_id AND p.vencedor = 'B'::text THEN p.placar2
            ELSE 0
        END) AS placar_vitoria,
    sum(
        CASE
            WHEN j.id = p.jogador1_id AND p.vencedor = 'B'::text THEN p.placar1
            WHEN j.id = p.jogador2_id AND p.vencedor = 'A'::text THEN p.placar2
            ELSE 0
        END) AS placar_derrota
   FROM jogador j
     LEFT JOIN (
    SELECT * 
    FROM public.vw_partida_sinuca_com_vencedor
    WHERE data_hora::time BETWEEN TIME '12:00' AND TIME '13:10'
) p ON j.id = p.jogador1_id OR j.id = p.jogador2_id
  GROUP BY j.id, j.nome
  ORDER BY (count(p.id)) DESC;


CREATE OR REPLACE VIEW public.vw_jogador_estatistica_fora_expediente
 AS
SELECT 
    j.id,
    j.nome,
    count(p.id) AS partidas,
    sum(
        CASE
            WHEN (j.id = p.jogador1_id OR j.id = p.jogador2_id) AND p.dupla_vencedora = 'A' THEN 1
            WHEN (j.id = p.jogador3_id OR j.id = p.jogador4_id) AND p.dupla_vencedora = 'B' THEN 1
            ELSE 0
        END) AS vitorias,
    sum(
        CASE
            WHEN (j.id = p.jogador1_id OR j.id = p.jogador2_id) AND p.dupla_vencedora = 'B' THEN 1
            WHEN (j.id = p.jogador3_id OR j.id = p.jogador4_id) AND p.dupla_vencedora = 'A' THEN 1
            ELSE 0
        END) AS derrotas,
    sum(
        CASE
            WHEN (j.id IN (p.jogador1_id, p.jogador2_id, p.jogador3_id, p.jogador4_id)) AND p.dupla_vencedora = 'AB' THEN 1
            ELSE 0
        END) AS empates,
    sum(
        CASE
            WHEN p.jogadorbct IS NOT NULL AND (
                (p.jogadorbct = 1 AND j.id = p.jogador1_id) OR
                (p.jogadorbct = 2 AND j.id = p.jogador2_id) OR
                (p.jogadorbct = 3 AND j.id = p.jogador3_id) OR
                (p.jogadorbct = 4 AND j.id = p.jogador4_id)
            ) THEN 1
            ELSE 0
        END) AS merda,
    sum(
        CASE
            WHEN (
                ((j.id = p.jogador1_id OR j.id = p.jogador2_id) AND p.dupla_vencedora = 'A') OR
                ((j.id = p.jogador3_id OR j.id = p.jogador4_id) AND p.dupla_vencedora = 'B')
            ) AND (p.jogadas ILIKE '%C%' OR p.jogadas ILIKE '%L%') THEN 1
            ELSE 0
        END) AS merito,
    sum(
        CASE
            WHEN (
                ((j.id = p.jogador1_id OR j.id = p.jogador2_id) AND p.dupla_vencedora = 'A') OR
                ((j.id = p.jogador3_id OR j.id = p.jogador4_id) AND p.dupla_vencedora = 'B')
            ) AND p.jogadas ILIKE '%L%' THEN 1
            ELSE 0
        END) AS laelo,
    sum(
        CASE
            WHEN (
                ((j.id = p.jogador1_id OR j.id = p.jogador2_id) AND p.dupla_vencedora = 'A') OR
                ((j.id = p.jogador3_id OR j.id = p.jogador4_id) AND p.dupla_vencedora = 'B')
            ) AND p.jogadas ILIKE '%C%' THEN 1
            ELSE 0
        END) AS cruzada,
    sum(
        CASE
            WHEN (j.id = p.jogador1_id OR j.id = p.jogador2_id) AND p.dupla_vencedora = 'A' THEN p.placar1
            WHEN (j.id = p.jogador3_id OR j.id = p.jogador4_id) AND p.dupla_vencedora = 'B' THEN p.placar2
            ELSE 0
        END) AS placar_vitoria,
    sum(
        CASE
            WHEN (j.id = p.jogador1_id OR j.id = p.jogador2_id) AND p.dupla_vencedora = 'B' THEN p.placar1
            WHEN (j.id = p.jogador3_id OR j.id = p.jogador4_id) AND p.dupla_vencedora = 'A' THEN p.placar2
            ELSE 0
        END) AS placar_derrota
FROM 
    jogador j
LEFT JOIN (
    SELECT * 
    FROM public.vw_partida_com_vencedor
    WHERE data_hora::time NOT BETWEEN TIME '12:00' AND TIME '13:10'
) p ON j.id = p.jogador1_id OR j.id = p.jogador2_id OR j.id = p.jogador3_id OR j.id = p.jogador4_id
GROUP BY j.id, j.nome
ORDER BY count(p.id) DESC;


CREATE OR REPLACE VIEW public.vw_jogador_estatistica_expediente
 AS
SELECT 
    j.id,
    j.nome,
    count(p.id) AS partidas,
    sum(
        CASE
            WHEN (j.id = p.jogador1_id OR j.id = p.jogador2_id) AND p.dupla_vencedora = 'A' THEN 1
            WHEN (j.id = p.jogador3_id OR j.id = p.jogador4_id) AND p.dupla_vencedora = 'B' THEN 1
            ELSE 0
        END) AS vitorias,
    sum(
        CASE
            WHEN (j.id = p.jogador1_id OR j.id = p.jogador2_id) AND p.dupla_vencedora = 'B' THEN 1
            WHEN (j.id = p.jogador3_id OR j.id = p.jogador4_id) AND p.dupla_vencedora = 'A' THEN 1
            ELSE 0
        END) AS derrotas,
    sum(
        CASE
            WHEN (j.id IN (p.jogador1_id, p.jogador2_id, p.jogador3_id, p.jogador4_id)) AND p.dupla_vencedora = 'AB' THEN 1
            ELSE 0
        END) AS empates,
    sum(
        CASE
            WHEN p.jogadorbct IS NOT NULL AND (
                (p.jogadorbct = 1 AND j.id = p.jogador1_id) OR
                (p.jogadorbct = 2 AND j.id = p.jogador2_id) OR
                (p.jogadorbct = 3 AND j.id = p.jogador3_id) OR
                (p.jogadorbct = 4 AND j.id = p.jogador4_id)
            ) THEN 1
            ELSE 0
        END) AS merda,
    sum(
        CASE
            WHEN (
                ((j.id = p.jogador1_id OR j.id = p.jogador2_id) AND p.dupla_vencedora = 'A') OR
                ((j.id = p.jogador3_id OR j.id = p.jogador4_id) AND p.dupla_vencedora = 'B')
            ) AND (p.jogadas ILIKE '%C%' OR p.jogadas ILIKE '%L%') THEN 1
            ELSE 0
        END) AS merito,
    sum(
        CASE
            WHEN (
                ((j.id = p.jogador1_id OR j.id = p.jogador2_id) AND p.dupla_vencedora = 'A') OR
                ((j.id = p.jogador3_id OR j.id = p.jogador4_id) AND p.dupla_vencedora = 'B')
            ) AND p.jogadas ILIKE '%L%' THEN 1
            ELSE 0
        END) AS laelo,
    sum(
        CASE
            WHEN (
                ((j.id = p.jogador1_id OR j.id = p.jogador2_id) AND p.dupla_vencedora = 'A') OR
                ((j.id = p.jogador3_id OR j.id = p.jogador4_id) AND p.dupla_vencedora = 'B')
            ) AND p.jogadas ILIKE '%C%' THEN 1
            ELSE 0
        END) AS cruzada,
    sum(
        CASE
            WHEN (j.id = p.jogador1_id OR j.id = p.jogador2_id) AND p.dupla_vencedora = 'A' THEN p.placar1
            WHEN (j.id = p.jogador3_id OR j.id = p.jogador4_id) AND p.dupla_vencedora = 'B' THEN p.placar2
            ELSE 0
        END) AS placar_vitoria,
    sum(
        CASE
            WHEN (j.id = p.jogador1_id OR j.id = p.jogador2_id) AND p.dupla_vencedora = 'B' THEN p.placar1
            WHEN (j.id = p.jogador3_id OR j.id = p.jogador4_id) AND p.dupla_vencedora = 'A' THEN p.placar2
            ELSE 0
        END) AS placar_derrota
FROM 
    jogador j
LEFT JOIN (
    SELECT * 
    FROM public.vw_partida_com_vencedor
    WHERE data_hora::time BETWEEN TIME '12:00' AND TIME '13:10'
) p ON j.id = p.jogador1_id OR j.id = p.jogador2_id OR j.id = p.jogador3_id OR j.id = p.jogador4_id
GROUP BY j.id, j.nome
ORDER BY count(p.id) DESC;





--26/06/2025

--DROP FUNCTION IF EXISTS fn_jogador_estatisticas_filtro(integer);
CREATE OR REPLACE FUNCTION fn_jogador_estatisticas_filtro(p_limite_partidas INTEGER)
RETURNS TABLE (
    id INTEGER,
    nome TEXT,
    partidas INTEGER,
    vitorias INTEGER,
    derrotas INTEGER,
    empates INTEGER,
    merda INTEGER,
    merito INTEGER,
    laelo INTEGER,
    cruzada INTEGER,
    placar_vitoria INTEGER,
    placar_derrota INTEGER
)
AS $$
BEGIN
  RETURN QUERY
  WITH partidas_com_rank AS (
    SELECT
      p.*,
      j.id AS jogador_id,
      ROW_NUMBER() OVER (
        PARTITION BY j.id
        ORDER BY p.data_hora DESC NULLS LAST
      ) AS rn
    FROM jogador j
    LEFT JOIN vw_partida_com_vencedor p
      ON j.id = p.jogador1_id OR j.id = p.jogador2_id OR j.id = p.jogador3_id OR j.id = p.jogador4_id
  )
  SELECT
    j.id,
    j.nome::TEXT,
    COUNT(p.id)::INTEGER AS partidas,
    SUM(CASE WHEN (j.id = p.jogador1_id OR j.id = p.jogador2_id) AND p.dupla_vencedora = 'A'
             OR (j.id = p.jogador3_id OR j.id = p.jogador4_id) AND p.dupla_vencedora = 'B' THEN 1 ELSE 0 END)::INTEGER AS vitorias,
    SUM(CASE WHEN (j.id = p.jogador1_id OR j.id = p.jogador2_id) AND p.dupla_vencedora = 'B'
             OR (j.id = p.jogador3_id OR j.id = p.jogador4_id) AND p.dupla_vencedora = 'A' THEN 1 ELSE 0 END)::INTEGER AS derrotas,
    SUM(CASE WHEN (j.id IN (p.jogador1_id, p.jogador2_id, p.jogador3_id, p.jogador4_id))
             AND p.dupla_vencedora = 'AB' THEN 1 ELSE 0 END)::INTEGER AS empates,
    SUM(CASE WHEN p.jogadorbct IS NOT NULL AND (
               (p.jogadorbct = 1 AND j.id = p.jogador1_id) OR
               (p.jogadorbct = 2 AND j.id = p.jogador2_id) OR
               (p.jogadorbct = 3 AND j.id = p.jogador3_id) OR
               (p.jogadorbct = 4 AND j.id = p.jogador4_id)) THEN 1 ELSE 0 END)::INTEGER AS merda,
    SUM(CASE WHEN ((j.id = p.jogador1_id OR j.id = p.jogador2_id) AND p.dupla_vencedora = 'A'
             OR (j.id = p.jogador3_id OR j.id = p.jogador4_id) AND p.dupla_vencedora = 'B')
             AND (p.jogadas ILIKE '%C%' OR p.jogadas ILIKE '%L%') THEN 1 ELSE 0 END)::INTEGER AS merito,
    SUM(CASE WHEN ((j.id = p.jogador1_id OR j.id = p.jogador2_id) AND p.dupla_vencedora = 'A'
             OR (j.id = p.jogador3_id OR j.id = p.jogador4_id) AND p.dupla_vencedora = 'B')
             AND p.jogadas ILIKE '%L%' THEN 1 ELSE 0 END)::INTEGER AS laelo,
    SUM(CASE WHEN ((j.id = p.jogador1_id OR j.id = p.jogador2_id) AND p.dupla_vencedora = 'A'
             OR (j.id = p.jogador3_id OR j.id = p.jogador4_id) AND p.dupla_vencedora = 'B')
             AND p.jogadas ILIKE '%C%' THEN 1 ELSE 0 END)::INTEGER AS cruzada,
    SUM(CASE WHEN (j.id = p.jogador1_id OR j.id = p.jogador2_id) AND p.dupla_vencedora = 'A' THEN p.placar1
             WHEN (j.id = p.jogador3_id OR j.id = p.jogador4_id) AND p.dupla_vencedora = 'B' THEN p.placar2
             ELSE 0 END)::INTEGER AS placar_vitoria,
    SUM(CASE WHEN (j.id = p.jogador1_id OR j.id = p.jogador2_id) AND p.dupla_vencedora = 'B' THEN p.placar1
             WHEN (j.id = p.jogador3_id OR j.id = p.jogador4_id) AND p.dupla_vencedora = 'A' THEN p.placar2
             ELSE 0 END)::INTEGER AS placar_derrota
  FROM jogador j
  LEFT JOIN partidas_com_rank p
    ON j.id = p.jogador_id AND p.rn <= p_limite_partidas
  GROUP BY j.id, j.nome
  ORDER BY COUNT(p.id) DESC;
END;
$$ LANGUAGE plpgsql;





--16/062025

CREATE OR REPLACE VIEW public.vw_rank_semanal AS 
WITH estatistica_semanal AS (
  SELECT
    j.id AS jogador_id,
    j.nome,
    date_trunc('week', p.data_hora)::date AS inicio_semana,
    (date_trunc('week', p.data_hora) + interval '6 days')::date AS fim_semana,

    -- Pontos
    sum(
        CASE
            WHEN ((j.id = p.jogador1_id OR j.id = p.jogador2_id) AND p.dupla_vencedora = 'A') OR
                 ((j.id = p.jogador3_id OR j.id = p.jogador4_id) AND p.dupla_vencedora = 'B')
            THEN 1 ELSE 0 END
    ) AS pontos,

    -- Vitórias
    count(
        CASE
            WHEN ((j.id = p.jogador1_id OR j.id = p.jogador2_id) AND p.dupla_vencedora = 'A') OR
                 ((j.id = p.jogador3_id OR j.id = p.jogador4_id) AND p.dupla_vencedora = 'B')
            THEN 1 ELSE NULL END
    ) AS vitorias,

    -- Merda
    sum(
        CASE
            WHEN p.jogadorbct IS NOT NULL AND (
                 (p.jogadorbct = 1 AND j.id = p.jogador1_id) OR
                 (p.jogadorbct = 2 AND j.id = p.jogador2_id) OR
                 (p.jogadorbct = 3 AND j.id = p.jogador3_id) OR
                 (p.jogadorbct = 4 AND j.id = p.jogador4_id)
            )
            THEN 1 ELSE 0 END
    ) AS merda,

    -- Mérito
    sum(
        CASE
            WHEN (
                ((j.id = p.jogador1_id OR j.id = p.jogador2_id) AND p.dupla_vencedora = 'A') OR
                ((j.id = p.jogador3_id OR j.id = p.jogador4_id) AND p.dupla_vencedora = 'B')
            ) AND (p.jogadas ~~* '%C%' OR p.jogadas ~~* '%L%')
            THEN 1 ELSE 0 END
    ) AS merito

  FROM jogador j
  LEFT JOIN vw_partida_com_vencedor p
    ON j.id IN (p.jogador1_id, p.jogador2_id, p.jogador3_id, p.jogador4_id)
  WHERE p.data_hora IS NOT NULL
  GROUP BY j.id, j.nome, date_trunc('week', p.data_hora)
),
ranking_por_semana AS (
  SELECT *,
         RANK() OVER (PARTITION BY inicio_semana ORDER BY pontos DESC) AS rk_pontos,
         ROW_NUMBER() OVER (PARTITION BY inicio_semana ORDER BY merda DESC, pontos ASC, vitorias ASC) AS rn_merda,
         ROW_NUMBER() OVER (PARTITION BY inicio_semana ORDER BY merito DESC, pontos DESC, vitorias DESC) AS rn_merito
  FROM estatistica_semanal
),
semanas_numeradas AS (
  SELECT DISTINCT
         inicio_semana,
         ROW_NUMBER() OVER (ORDER BY inicio_semana) AS semana
  FROM ranking_por_semana
),
top_semanal AS (
  SELECT DISTINCT
    sn.semana,
    es.inicio_semana,
    es.fim_semana,

    -- Top pontos
    FIRST_VALUE(es.jogador_id) OVER (PARTITION BY es.inicio_semana ORDER BY rk_pontos) AS id_top_pontos,
    FIRST_VALUE(es.nome) OVER (PARTITION BY es.inicio_semana ORDER BY rk_pontos) AS nome_top_pontos,
    FIRST_VALUE(es.pontos) OVER (PARTITION BY es.inicio_semana ORDER BY rk_pontos) AS pontos,

    -- Top merda
    FIRST_VALUE(es.jogador_id) OVER (PARTITION BY es.inicio_semana ORDER BY rn_merda) AS id_top_merda,
    FIRST_VALUE(es.nome) OVER (PARTITION BY es.inicio_semana ORDER BY rn_merda) AS nome_top_merda,
    FIRST_VALUE(es.merda) OVER (PARTITION BY es.inicio_semana ORDER BY rn_merda) AS merda,

    -- Top mérito
    FIRST_VALUE(es.jogador_id) OVER (PARTITION BY es.inicio_semana ORDER BY rn_merito) AS id_top_merito,
    FIRST_VALUE(es.nome) OVER (PARTITION BY es.inicio_semana ORDER BY rn_merito) AS nome_top_merito,
    FIRST_VALUE(es.merito) OVER (PARTITION BY es.inicio_semana ORDER BY rn_merito) AS merito

  FROM ranking_por_semana es
  JOIN semanas_numeradas sn ON es.inicio_semana = sn.inicio_semana
)
SELECT DISTINCT
  semana,
  inicio_semana,
  fim_semana,
  id_top_pontos,
  nome_top_pontos,
  pontos,
  id_top_merda,
  nome_top_merda,
  merda,
  id_top_merito,
  nome_top_merito,
  merito
FROM top_semanal
ORDER BY semana DESC;




-- 04/06/2025

DROP VIEW IF EXISTS public.vw_comparacao_rivais_sinuca;
CREATE OR REPLACE VIEW public.vw_comparacao_rivais_sinuca AS
WITH confrontos AS (
    SELECT 
        LEAST(p.jogador1_id, p.jogador2_id) AS jogador1_id,
        GREATEST(p.jogador1_id, p.jogador2_id) AS jogador2_id,
        j.id AS jogador_id,
        (LEAST(p.jogador1_id, p.jogador2_id)::text || ',' || GREATEST(p.jogador1_id, p.jogador2_id)::text) AS id_rival,
        CASE
            WHEN p.jogador1_id < p.jogador2_id THEN j1.nome || ',' || j2.nome
            ELSE j2.nome || ',' || j1.nome
        END AS nome_rival,
        CASE WHEN j.id = p.jogador1_id AND p.vencedor = 'A' THEN 1
             WHEN j.id = p.jogador2_id AND p.vencedor = 'B' THEN 1
             ELSE 0
        END AS vitoria,
        CASE WHEN p.vencedor = 'AB' THEN 1 ELSE 0 END AS empate,
        CASE WHEN j.id = p.jogador1_id AND p.vencedor = 'A' THEN p.placar1
             WHEN j.id = p.jogador2_id AND p.vencedor = 'B' THEN p.placar2
             ELSE 0
        END AS placar_pro,
        CASE WHEN j.id = p.jogador1_id AND p.vencedor = 'B' THEN p.placar1
             WHEN j.id = p.jogador2_id AND p.vencedor = 'A' THEN p.placar2
             ELSE 0
        END AS placar_contra,
        CASE
            WHEN p.jogadorbct IS NOT NULL AND (p.jogadorbct = 1 AND j.id = p.jogador1_id OR p.jogadorbct = 2 AND j.id = p.jogador2_id)
            THEN 1 ELSE 0
        END AS merda,
        CASE
            WHEN p.vencedor = 'A' AND p.placar2 = 0 AND j.id = p.jogador1_id THEN 1
            WHEN p.vencedor = 'B' AND p.placar1 = 0 AND j.id = p.jogador2_id THEN 1
            ELSE 0
        END AS merito
    FROM vw_partida_sinuca_com_vencedor p
    JOIN jogador j1 ON j1.id = p.jogador1_id
    JOIN jogador j2 ON j2.id = p.jogador2_id
    JOIN jogador j ON j.id IN (p.jogador1_id, p.jogador2_id)
),
agregado_por_jogador AS (
    SELECT 
        id_rival,
        nome_rival,
        jogador_id,
        SUM(vitoria) AS vitoria,
        SUM(placar_pro) AS placar_vitoria,
        SUM(placar_contra) AS placar_derrota,
        SUM(merda) AS merda,
        SUM(merito) AS merito,
        SUM(empate) AS empate
    FROM confrontos
    GROUP BY id_rival, nome_rival, jogador_id
),
contagem_partidas AS (
    SELECT 
        LEAST(jogador1_id, jogador2_id)::text || ',' || GREATEST(jogador1_id, jogador2_id)::text AS id_rival,
        COUNT(*) AS partidas
    FROM vw_partida_sinuca_com_vencedor
    GROUP BY LEAST(jogador1_id, jogador2_id), GREATEST(jogador1_id, jogador2_id)
),
agregado_final AS (
    SELECT 
        a.id_rival,
        a.nome_rival,
        STRING_AGG(a.vitoria::text, ',' ORDER BY a.jogador_id) AS vitorias,
        STRING_AGG(a.placar_vitoria::text, ',' ORDER BY a.jogador_id) AS placar_vitoria,
        STRING_AGG(a.placar_derrota::text, ',' ORDER BY a.jogador_id) AS placar_derrota,
        STRING_AGG(a.merda::text, ',' ORDER BY a.jogador_id) AS merdas,
        STRING_AGG(a.merito::text, ',' ORDER BY a.jogador_id) AS meritos,
        (SUM(a.empate))::int AS empates,
        p.partidas
    FROM agregado_por_jogador a
    JOIN contagem_partidas p ON p.id_rival = a.id_rival
    GROUP BY a.id_rival, a.nome_rival, p.partidas
)
SELECT * FROM agregado_final
ORDER BY partidas DESC;





-- 01/06/2025

CREATE OR REPLACE VIEW public.vw_partida_sinuca_com_vencedor
 AS
 SELECT partida_sinuca.id,
    partida_sinuca.data_hora,
    partida_sinuca.jogador1_id,
    partida_sinuca.jogador2_id,
    partida_sinuca.placar1,
    partida_sinuca.placar2,
    partida_sinuca.jogadorbct,
        CASE
            WHEN partida_sinuca.jogadorbct IS NOT NULL THEN
            CASE
                WHEN partida_sinuca.jogadorbct = ANY (ARRAY[1]) THEN 'B'::text
                WHEN partida_sinuca.jogadorbct = ANY (ARRAY[2]) THEN 'A'::text
                WHEN partida_sinuca.placar1 > partida_sinuca.placar2 THEN 'A'::text
                WHEN partida_sinuca.placar2 > partida_sinuca.placar1 THEN 'B'::text
                ELSE 'AB'::text
            END
            ELSE
            CASE
                WHEN partida_sinuca.placar1 > partida_sinuca.placar2 THEN 'A'::text
                WHEN partida_sinuca.placar2 > partida_sinuca.placar1 THEN 'B'::text
                ELSE 'AB'::text
            END
        END AS vencedor
   FROM partida_sinuca;





CREATE OR REPLACE VIEW public.vw_jogador_estatistica_sinuca
 AS
 SELECT j.id,
    j.nome,
    count(p.id) AS partidas_sinuca,
    sum(
        CASE
            WHEN j.id = p.jogador1_id AND p.vencedor = 'A'::text THEN 1
            WHEN j.id = p.jogador2_id AND p.vencedor = 'B'::text THEN 1
            ELSE 0
        END) AS vitorias,
    sum(
        CASE
            WHEN j.id = p.jogador1_id AND p.vencedor = 'B'::text THEN 1
            WHEN j.id = p.jogador2_id AND p.vencedor = 'A'::text THEN 1
            ELSE 0
        END) AS derrotas,
    sum(
        CASE
            WHEN (j.id = p.jogador1_id OR j.id = p.jogador2_id) AND p.vencedor = 'AB'::text THEN 1
            ELSE 0
        END) AS empates,
    sum(
        CASE
            WHEN p.jogadorbct IS NOT NULL AND (p.jogadorbct = 1 AND j.id = p.jogador1_id OR p.jogadorbct = 2 AND j.id = p.jogador2_id ) THEN 1
            ELSE 0
        END) AS merda,
    sum(
        CASE
            WHEN (p.vencedor = 'A'::text AND p.placar2 = 0 AND p.jogador1_id = j.id) OR (p.vencedor = 'B'::text AND p.placar1 = 0 AND p.jogador2_id = j.id) THEN 1
            ELSE 0
        END) AS merito,
    sum(
        CASE
            WHEN j.id = p.jogador1_id AND p.vencedor = 'A'::text THEN p.placar1
            WHEN j.id = p.jogador2_id AND p.vencedor = 'B'::text THEN p.placar2
            ELSE 0
        END) AS placar_vitoria,
    sum(
        CASE
            WHEN j.id = p.jogador1_id AND p.vencedor = 'B'::text THEN p.placar1
            WHEN j.id = p.jogador2_id AND p.vencedor = 'A'::text THEN p.placar2
            ELSE 0
        END) AS placar_derrota
   FROM jogador j
     LEFT JOIN vw_partida_sinuca_com_vencedor p ON j.id = p.jogador1_id OR j.id = p.jogador2_id 
  GROUP BY j.id, j.nome
  ORDER BY (count(p.id)) DESC;


DROP VIEW IF EXISTS public.vw_comparacao_rivais_sinuca;
CREATE OR REPLACE VIEW public.vw_comparacao_rivais_sinuca AS
WITH confrontos AS (
    SELECT 
        LEAST(p.jogador1_id, p.jogador2_id) AS jogador1_id,
        GREATEST(p.jogador1_id, p.jogador2_id) AS jogador2_id,
        j.id AS jogador_id,
        j.nome AS nome_jogador,
        (LEAST(p.jogador1_id, p.jogador2_id))::text || ',' || (GREATEST(p.jogador1_id, p.jogador2_id))::text AS id_rival,
        CASE 
            WHEN p.jogador1_id < p.jogador2_id THEN j1.nome || ',' || j2.nome
            ELSE j2.nome || ',' || j1.nome
        END AS nome_rival,

        CASE 
            WHEN j.id = p.jogador1_id AND p.vencedor = 'A' THEN 1
            WHEN j.id = p.jogador2_id AND p.vencedor = 'B' THEN 1
            ELSE 0
        END AS vitoria,

        CASE 
            WHEN p.vencedor = 'AB' THEN 1 ELSE 0
        END AS empate,

        -- Novo: placar_pro só se venceu
        CASE 
            WHEN j.id = p.jogador1_id AND p.vencedor = 'A' THEN p.placar1
            WHEN j.id = p.jogador2_id AND p.vencedor = 'B' THEN p.placar2
            ELSE 0
        END AS placar_pro,

        -- Já corrigido antes: placar_contra só se perdeu
        CASE 
            WHEN j.id = p.jogador1_id AND p.vencedor = 'B' THEN p.placar1
            WHEN j.id = p.jogador2_id AND p.vencedor = 'A' THEN p.placar2
            ELSE 0
        END AS placar_contra,

        CASE 
            WHEN p.jogadorbct IS NOT NULL AND ((p.jogadorbct = 1 AND j.id = p.jogador1_id) OR (p.jogadorbct = 2 AND j.id = p.jogador2_id)) THEN 1
            ELSE 0
        END AS merda,

        CASE
            WHEN p.vencedor = 'A' AND p.placar2 = 0 AND p.jogador1_id = j.id THEN 1
            WHEN p.vencedor = 'B' AND p.placar1 = 0 AND p.jogador2_id = j.id THEN 1
            ELSE 0
        END AS merito
    FROM vw_partida_sinuca_com_vencedor p
    JOIN jogador j1 ON j1.id = p.jogador1_id
    JOIN jogador j2 ON j2.id = p.jogador2_id
    JOIN jogador j ON j.id IN (p.jogador1_id, p.jogador2_id)
)
SELECT 
    id_rival,
    nome_rival,
    COUNT(*) / 2 AS partidas,
    SUM(empate) / 2 AS empates,
    STRING_AGG(vitoria::text, ',' ORDER BY jogador_id) AS vitorias,
    STRING_AGG(placar_pro::text, ',' ORDER BY jogador_id) AS placar_vitoria,
    STRING_AGG(placar_contra::text, ',' ORDER BY jogador_id) AS placar_derrota,
    STRING_AGG(merda::text, ',' ORDER BY jogador_id) AS merdas,
    STRING_AGG(merito::text, ',' ORDER BY jogador_id) AS meritos
FROM confrontos
GROUP BY id_rival, nome_rival
ORDER BY partidas DESC;










--30/05/25



DROP VIEW IF EXISTS public.vw_jogador_estatistica;
CREATE OR REPLACE VIEW public.vw_jogador_estatistica AS
SELECT 
    j.id,
    j.nome,
    count(p.id) AS partidas,
    
    -- VITÓRIAS
    sum(
        CASE
            WHEN (j.id = p.jogador1_id OR j.id = p.jogador2_id) AND p.dupla_vencedora = 'A' THEN 1
            WHEN (j.id = p.jogador3_id OR j.id = p.jogador4_id) AND p.dupla_vencedora = 'B' THEN 1
            ELSE 0
        END
    ) AS vitorias,

    -- DERROTAS
    sum(
        CASE
            WHEN (j.id = p.jogador1_id OR j.id = p.jogador2_id) AND p.dupla_vencedora = 'B' THEN 1
            WHEN (j.id = p.jogador3_id OR j.id = p.jogador4_id) AND p.dupla_vencedora = 'A' THEN 1
            ELSE 0
        END
    ) AS derrotas,

    -- EMPATES
    sum(
        CASE
            WHEN (j.id = p.jogador1_id OR j.id = p.jogador2_id OR j.id = p.jogador3_id OR j.id = p.jogador4_id)
                AND p.dupla_vencedora = 'AB' THEN 1
            ELSE 0
        END
    ) AS empates,

    -- MERDA
    sum(
        CASE
            WHEN p.jogadorbct IS NOT NULL AND (
                (p.jogadorbct = 1 AND j.id = p.jogador1_id) OR 
                (p.jogadorbct = 2 AND j.id = p.jogador2_id) OR 
                (p.jogadorbct = 3 AND j.id = p.jogador3_id) OR 
                (p.jogadorbct = 4 AND j.id = p.jogador4_id)
            ) THEN 1
            ELSE 0
        END
    ) AS merda,

    -- MÉRITO
    sum(
        CASE
            WHEN (
                ((j.id = p.jogador1_id OR j.id = p.jogador2_id) AND p.dupla_vencedora = 'A') OR 
                ((j.id = p.jogador3_id OR j.id = p.jogador4_id) AND p.dupla_vencedora = 'B')
            )
            AND (p.jogadas ILIKE '%C%' OR p.jogadas ILIKE '%L%')
            THEN 1
            ELSE 0
        END
    ) AS merito,

    -- LAELO
    sum(
        CASE
            WHEN (
                ((j.id = p.jogador1_id OR j.id = p.jogador2_id) AND p.dupla_vencedora = 'A') OR 
                ((j.id = p.jogador3_id OR j.id = p.jogador4_id) AND p.dupla_vencedora = 'B')
            )
            AND p.jogadas ILIKE '%L%'
            THEN 1
            ELSE 0
        END
    ) AS laelo,

    -- CRUZADA
    sum(
        CASE
            WHEN (
                ((j.id = p.jogador1_id OR j.id = p.jogador2_id) AND p.dupla_vencedora = 'A') OR 
                ((j.id = p.jogador3_id OR j.id = p.jogador4_id) AND p.dupla_vencedora = 'B')
            )
            AND p.jogadas ILIKE '%C%'
            THEN 1
            ELSE 0
        END
    ) AS cruzada,

    -- PLACAR DAS VITÓRIAS
    sum(
        CASE
            WHEN (j.id = p.jogador1_id OR j.id = p.jogador2_id) AND p.dupla_vencedora = 'A' THEN p.placar1
            WHEN (j.id = p.jogador3_id OR j.id = p.jogador4_id) AND p.dupla_vencedora = 'B' THEN p.placar2
            ELSE 0
        END
    ) AS placar_vitoria,

    -- PLACAR DAS DERROTAS
    sum(
        CASE
            WHEN (j.id = p.jogador1_id OR j.id = p.jogador2_id) AND p.dupla_vencedora = 'B' THEN p.placar1
            WHEN (j.id = p.jogador3_id OR j.id = p.jogador4_id) AND p.dupla_vencedora = 'A' THEN p.placar2
            ELSE 0
        END
    ) AS placar_derrota

FROM 
    jogador j
LEFT JOIN 
    vw_partida_com_vencedor p 
    ON j.id IN (p.jogador1_id, p.jogador2_id, p.jogador3_id, p.jogador4_id)
GROUP BY 
    j.id, j.nome
ORDER BY 
    count(p.id) DESC;



CREATE OR REPLACE VIEW public.vw_dupla_estatistica AS
SELECT
    CASE
        WHEN j1.nome < j2.nome THEN j1.id || ',' || j2.id
        ELSE j2.id || ',' || j1.id
    END AS id,
    CASE
        WHEN j1.nome < j2.nome THEN j1.nome || ',' || j2.nome
        ELSE j2.nome || ',' || j1.nome
    END AS nome,
    count(*) AS partidas,
    sum(
        CASE
            WHEN (p.jogador1_id = j1.id AND p.jogador2_id = j2.id AND p.dupla_vencedora = 'A')
              OR (p.jogador2_id = j1.id AND p.jogador1_id = j2.id AND p.dupla_vencedora = 'A')
              OR (p.jogador3_id = j1.id AND p.jogador4_id = j2.id AND p.dupla_vencedora = 'B')
              OR (p.jogador4_id = j1.id AND p.jogador3_id = j2.id AND p.dupla_vencedora = 'B')
            THEN 1 ELSE 0
        END
    ) AS vitorias,
    sum(
        CASE
            WHEN (p.jogador1_id = j1.id AND p.jogador2_id = j2.id AND p.dupla_vencedora = 'B')
              OR (p.jogador2_id = j1.id AND p.jogador1_id = j2.id AND p.dupla_vencedora = 'B')
              OR (p.jogador3_id = j1.id AND p.jogador4_id = j2.id AND p.dupla_vencedora = 'A')
              OR (p.jogador4_id = j1.id AND p.jogador3_id = j2.id AND p.dupla_vencedora = 'A')
            THEN 1 ELSE 0
        END
    ) AS derrotas,
    sum(
        CASE
            WHEN (
                (p.jogador1_id = j1.id AND p.jogador2_id = j2.id)
              OR (p.jogador2_id = j1.id AND p.jogador1_id = j2.id)
              OR (p.jogador3_id = j1.id AND p.jogador4_id = j2.id)
              OR (p.jogador4_id = j1.id AND p.jogador3_id = j2.id)
            ) AND p.dupla_vencedora = 'AB'
            THEN 1 ELSE 0
        END
    ) AS empates,
    sum(
        CASE
            WHEN (
                (p.jogador1_id = j1.id AND p.jogador2_id = j2.id AND p.dupla_vencedora = 'A')
              OR (p.jogador2_id = j1.id AND p.jogador1_id = j2.id AND p.dupla_vencedora = 'A')
              OR (p.jogador3_id = j1.id AND p.jogador4_id = j2.id AND p.dupla_vencedora = 'B')
              OR (p.jogador4_id = j1.id AND p.jogador3_id = j2.id AND p.dupla_vencedora = 'B')
            ) AND (p.jogadas ILIKE '%C%' OR p.jogadas ILIKE '%L%')
            THEN 1 ELSE 0
        END
    ) AS merito,
    sum(
        CASE
            WHEN (
                (p.jogador1_id = j1.id AND p.jogador2_id = j2.id AND p.dupla_vencedora = 'A')
              OR (p.jogador2_id = j1.id AND p.jogador1_id = j2.id AND p.dupla_vencedora = 'A')
              OR (p.jogador3_id = j1.id AND p.jogador4_id = j2.id AND p.dupla_vencedora = 'B')
              OR (p.jogador4_id = j1.id AND p.jogador3_id = j2.id AND p.dupla_vencedora = 'B')
            ) AND p.jogadas ILIKE '%L%'
            THEN 1 ELSE 0
        END
    ) AS laelo,
    sum(
        CASE
            WHEN (
                (p.jogador1_id = j1.id AND p.jogador2_id = j2.id AND p.dupla_vencedora = 'A')
              OR (p.jogador2_id = j1.id AND p.jogador1_id = j2.id AND p.dupla_vencedora = 'A')
              OR (p.jogador3_id = j1.id AND p.jogador4_id = j2.id AND p.dupla_vencedora = 'B')
              OR (p.jogador4_id = j1.id AND p.jogador3_id = j2.id AND p.dupla_vencedora = 'B')
            ) AND p.jogadas ILIKE '%C%'
            THEN 1 ELSE 0
        END
    ) AS cruzada,
    -- NOVO: placar_vitoria
    sum(
        CASE
            WHEN (p.jogador1_id = j1.id AND p.jogador2_id = j2.id AND p.dupla_vencedora = 'A')
              OR (p.jogador2_id = j1.id AND p.jogador1_id = j2.id AND p.dupla_vencedora = 'A')
            THEN p.placar1
            WHEN (p.jogador3_id = j1.id AND p.jogador4_id = j2.id AND p.dupla_vencedora = 'B')
              OR (p.jogador4_id = j1.id AND p.jogador3_id = j2.id AND p.dupla_vencedora = 'B')
            THEN p.placar2
            ELSE 0
        END
    ) AS placar_vitoria,
    -- NOVO: placar_derrota
    sum(
        CASE
            WHEN (p.jogador1_id = j1.id AND p.jogador2_id = j2.id AND p.dupla_vencedora = 'B')
              OR (p.jogador2_id = j1.id AND p.jogador1_id = j2.id AND p.dupla_vencedora = 'B')
            THEN p.placar1
            WHEN (p.jogador3_id = j1.id AND p.jogador4_id = j2.id AND p.dupla_vencedora = 'A')
              OR (p.jogador4_id = j1.id AND p.jogador3_id = j2.id AND p.dupla_vencedora = 'A')
            THEN p.placar2
            ELSE 0
        END
    ) AS placar_derrota
FROM vw_partida_com_vencedor p
JOIN jogador j1 ON j1.id IN (p.jogador1_id, p.jogador2_id, p.jogador3_id, p.jogador4_id)
JOIN jogador j2 ON j2.id IN (p.jogador1_id, p.jogador2_id, p.jogador3_id, p.jogador4_id) AND j1.id < j2.id
WHERE
    (p.jogador1_id = j1.id AND p.jogador2_id = j2.id)
 OR (p.jogador2_id = j1.id AND p.jogador1_id = j2.id)
 OR (p.jogador3_id = j1.id AND p.jogador4_id = j2.id)
 OR (p.jogador4_id = j1.id AND p.jogador3_id = j2.id)
GROUP BY
    CASE
        WHEN j1.nome < j2.nome THEN j1.id || ',' || j2.id
        ELSE j2.id || ',' || j1.id
    END,
    CASE
        WHEN j1.nome < j2.nome THEN j1.nome || ',' || j2.nome
        ELSE j2.nome || ',' || j1.nome
    END
ORDER BY count(*) DESC;


























--27/05/25 11:45

--ALTER TABLE partida ADD COLUMN jogadas TEXT;


--28/05/25 10:42

CREATE OR REPLACE VIEW vw_partida_com_vencedor AS
SELECT *,
    CASE
        -- 1. Se houver valor em jogadorbct, usamos isso para definir o perdedor
        WHEN jogadorbct IS NOT NULL THEN
            CASE 
                WHEN jogadorbct IN (1, 2) THEN 'B'  -- jogador da dupla A perdeu → dupla B venceu
                WHEN jogadorbct IN (3, 4) THEN 'A'  -- jogador da dupla B perdeu → dupla A venceu
				WHEN placar1 > placar2 THEN 'A'
                WHEN placar2 > placar1 THEN 'B'
                ELSE 'AB'  -- empate
            END
        -- 2. Se jogadorbct for NULL, usamos os placares
        ELSE
            CASE 
                WHEN placar1 > placar2 THEN 'A'
                WHEN placar2 > placar1 THEN 'B'
                ELSE 'AB'  -- empate
            END
    END AS dupla_vencedora
FROM partida;


CREATE OR REPLACE VIEW vw_jogador_estatistica AS
SELECT 
    j.id,
    j.nome,
    COUNT(p.id) AS partidas,

    -- Vitórias
    SUM(
        CASE 
            WHEN (j.id = p.jogador1_id OR j.id = p.jogador2_id) AND p.dupla_vencedora = 'A' THEN 1
            WHEN (j.id = p.jogador3_id OR j.id = p.jogador4_id) AND p.dupla_vencedora = 'B' THEN 1
            ELSE 0
        END
    ) AS vitorias,

    -- Derrotas
    SUM(
        CASE 
            WHEN (j.id = p.jogador1_id OR j.id = p.jogador2_id) AND p.dupla_vencedora = 'B' THEN 1
            WHEN (j.id = p.jogador3_id OR j.id = p.jogador4_id) AND p.dupla_vencedora = 'A' THEN 1
            ELSE 0
        END
    ) AS derrotas,

    -- Empates
    SUM(
        CASE 
            WHEN (j.id IN (p.jogador1_id, p.jogador2_id, p.jogador3_id, p.jogador4_id)) AND p.dupla_vencedora = 'AB' THEN 1
            ELSE 0
        END
    ) AS empates,

    -- Merda
    SUM(
        CASE
            WHEN p.jogadorbct IS NOT NULL AND
                (
                    (p.jogadorbct = 1 AND j.id = p.jogador1_id) OR
                    (p.jogadorbct = 2 AND j.id = p.jogador2_id) OR
                    (p.jogadorbct = 3 AND j.id = p.jogador3_id) OR
                    (p.jogadorbct = 4 AND j.id = p.jogador4_id)
                )
            THEN 1
            ELSE 0
        END
    ) AS merda,

    -- Mérito
    SUM(
        CASE
            WHEN
                (
                    ((j.id = p.jogador1_id OR j.id = p.jogador2_id) AND p.dupla_vencedora = 'A') OR
                    ((j.id = p.jogador3_id OR j.id = p.jogador4_id) AND p.dupla_vencedora = 'B')
                )
                AND (p.jogadas ILIKE '%C%' OR p.jogadas ILIKE '%L%')
            THEN 1
            ELSE 0
        END
    ) AS merito,

    -- Laelo
    SUM(
        CASE
            WHEN
                (
                    ((j.id = p.jogador1_id OR j.id = p.jogador2_id) AND p.dupla_vencedora = 'A') OR
                    ((j.id = p.jogador3_id OR j.id = p.jogador4_id) AND p.dupla_vencedora = 'B')
                )
                AND p.jogadas ILIKE '%L%'
            THEN 1
            ELSE 0
        END
    ) AS laelo,

    -- Cruzada
    SUM(
        CASE
            WHEN
                (
                    ((j.id = p.jogador1_id OR j.id = p.jogador2_id) AND p.dupla_vencedora = 'A') OR
                    ((j.id = p.jogador3_id OR j.id = p.jogador4_id) AND p.dupla_vencedora = 'B')
                )
                AND p.jogadas ILIKE '%C%'
            THEN 1
            ELSE 0
        END
    ) AS cruzada

FROM jogador j
LEFT JOIN vw_partida_com_vencedor p 
    ON j.id IN (p.jogador1_id, p.jogador2_id, p.jogador3_id, p.jogador4_id)
GROUP BY j.id, j.nome
ORDER BY partidas DESC;


CREATE OR REPLACE VIEW vw_dupla_estatistica AS
SELECT
    -- Dupla ID ordenado por nome (menor nome primeiro)
    CASE
        WHEN j1.nome < j2.nome THEN j1.id || ',' || j2.id
        ELSE j2.id || ',' || j1.id
    END AS id,

    -- Nomes ordenados alfabeticamente
    CASE
        WHEN j1.nome < j2.nome THEN j1.nome || ',' || j2.nome
        ELSE j2.nome || ',' || j1.nome
    END AS nome,

    COUNT(*) AS partidas,

    -- Vitórias
    SUM(
        CASE 
            WHEN (p.jogador1_id = j1.id AND p.jogador2_id = j2.id AND p.dupla_vencedora = 'A') OR
                 (p.jogador2_id = j1.id AND p.jogador1_id = j2.id AND p.dupla_vencedora = 'A') OR
                 (p.jogador3_id = j1.id AND p.jogador4_id = j2.id AND p.dupla_vencedora = 'B') OR
                 (p.jogador4_id = j1.id AND p.jogador3_id = j2.id AND p.dupla_vencedora = 'B')
            THEN 1 ELSE 0
        END
    ) AS vitorias,

    -- Derrotas
    SUM(
        CASE 
            WHEN (p.jogador1_id = j1.id AND p.jogador2_id = j2.id AND p.dupla_vencedora = 'B') OR
                 (p.jogador2_id = j1.id AND p.jogador1_id = j2.id AND p.dupla_vencedora = 'B') OR
                 (p.jogador3_id = j1.id AND p.jogador4_id = j2.id AND p.dupla_vencedora = 'A') OR
                 (p.jogador4_id = j1.id AND p.jogador3_id = j2.id AND p.dupla_vencedora = 'A')
            THEN 1 ELSE 0
        END
    ) AS derrotas,

    -- Empates
    SUM(
        CASE 
            WHEN ((p.jogador1_id = j1.id AND p.jogador2_id = j2.id) OR
                  (p.jogador2_id = j1.id AND p.jogador1_id = j2.id) OR
                  (p.jogador3_id = j1.id AND p.jogador4_id = j2.id) OR
                  (p.jogador4_id = j1.id AND p.jogador3_id = j2.id))
                 AND p.dupla_vencedora = 'AB'
            THEN 1 ELSE 0
        END
    ) AS empates,

    -- Mérito (vitória + C ou L na jogada)
    SUM(
        CASE
            WHEN (
                ((p.jogador1_id = j1.id AND p.jogador2_id = j2.id AND p.dupla_vencedora = 'A') OR
                 (p.jogador2_id = j1.id AND p.jogador1_id = j2.id AND p.dupla_vencedora = 'A') OR
                 (p.jogador3_id = j1.id AND p.jogador4_id = j2.id AND p.dupla_vencedora = 'B') OR
                 (p.jogador4_id = j1.id AND p.jogador3_id = j2.id AND p.dupla_vencedora = 'B'))
                AND (p.jogadas ILIKE '%C%' OR p.jogadas ILIKE '%L%')
            )
            THEN 1 ELSE 0
        END
    ) AS merito,

    -- Laelo (vitória + L)
    SUM(
        CASE
            WHEN (
                ((p.jogador1_id = j1.id AND p.jogador2_id = j2.id AND p.dupla_vencedora = 'A') OR
                 (p.jogador2_id = j1.id AND p.jogador1_id = j2.id AND p.dupla_vencedora = 'A') OR
                 (p.jogador3_id = j1.id AND p.jogador4_id = j2.id AND p.dupla_vencedora = 'B') OR
                 (p.jogador4_id = j1.id AND p.jogador3_id = j2.id AND p.dupla_vencedora = 'B'))
                AND p.jogadas ILIKE '%L%'
            )
            THEN 1 ELSE 0
        END
    ) AS laelo,

    -- Cruzada (vitória + C)
    SUM(
        CASE
            WHEN (
                ((p.jogador1_id = j1.id AND p.jogador2_id = j2.id AND p.dupla_vencedora = 'A') OR
                 (p.jogador2_id = j1.id AND p.jogador1_id = j2.id AND p.dupla_vencedora = 'A') OR
                 (p.jogador3_id = j1.id AND p.jogador4_id = j2.id AND p.dupla_vencedora = 'B') OR
                 (p.jogador4_id = j1.id AND p.jogador3_id = j2.id AND p.dupla_vencedora = 'B'))
                AND p.jogadas ILIKE '%C%'
            )
            THEN 1 ELSE 0
        END
    ) AS cruzada

FROM vw_partida_com_vencedor p

-- Unindo com jogadores da dupla
JOIN jogador j1 ON j1.id IN (p.jogador1_id, p.jogador2_id, p.jogador3_id, p.jogador4_id)
JOIN jogador j2 ON j2.id IN (p.jogador1_id, p.jogador2_id, p.jogador3_id, p.jogador4_id)
    AND j1.id < j2.id  -- Evita pares duplicados e autojoins

-- Garantir que são da mesma dupla
WHERE 
    ( (p.jogador1_id = j1.id AND p.jogador2_id = j2.id) OR
      (p.jogador2_id = j1.id AND p.jogador1_id = j2.id) OR
      (p.jogador3_id = j1.id AND p.jogador4_id = j2.id) OR
      (p.jogador4_id = j1.id AND p.jogador3_id = j2.id) )

GROUP BY
    CASE
        WHEN j1.nome < j2.nome THEN j1.id || ',' || j2.id
        ELSE j2.id || ',' || j1.id
    END,
    CASE
        WHEN j1.nome < j2.nome THEN j1.nome || ',' || j2.nome
        ELSE j2.nome || ',' || j1.nome
    END
ORDER BY partidas DESC;
