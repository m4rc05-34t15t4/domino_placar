SELECT 
    j.nome AS jogador,
    r.jogador_id,
    COUNT(*) FILTER (WHERE r.resultado = 'vitória') AS vitorias,
    COUNT(*) FILTER (WHERE r.resultado = 'derrota') AS derrotas,
    COUNT(*) AS total_partidas,
    COUNT(DISTINCT r.dupla_id) AS total_duplas
FROM (
    -- Jogador 1
    SELECT 
        jogador1_id AS jogador_id,
        CASE 
            WHEN placar1 > placar2 THEN 'vitória'
            WHEN placar1 < placar2 THEN 'derrota'
            ELSE 'empate'
        END AS resultado,
        jogador2_id AS dupla_id
    FROM partida

    UNION ALL

    -- Jogador 2
    SELECT 
        jogador2_id,
        CASE 
            WHEN placar1 > placar2 THEN 'vitória'
            WHEN placar1 < placar2 THEN 'derrota'
            ELSE 'empate'
        END,
        jogador1_id
    FROM partida

    UNION ALL

    -- Jogador 3
    SELECT 
        jogador3_id,
        CASE 
            WHEN placar2 > placar1 THEN 'vitória'
            WHEN placar2 < placar1 THEN 'derrota'
            ELSE 'empate'
        END,
        jogador4_id
    FROM partida

    UNION ALL

    -- Jogador 4
    SELECT 
        jogador4_id,
        CASE 
            WHEN placar2 > placar1 THEN 'vitória'
            WHEN placar2 < placar1 THEN 'derrota'
            ELSE 'empate'
        END,
        jogador3_id
    FROM partida
) r
JOIN jogador j ON j.id = r.jogador_id
WHERE r.jogador_id IS NOT NULL
GROUP BY j.nome, r.jogador_id
ORDER BY derrotas DESC, j.nome;
